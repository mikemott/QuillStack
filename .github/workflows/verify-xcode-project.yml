name: Verify Xcode Project Integrity

on:
  pull_request:
    paths:
      - '**.swift'
      - '**.xcodeproj/**'

jobs:
  verify-project:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode 16.2
        run: |
          sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
          xcodebuild -version

      - name: Check for Swift files not in Xcode project
        run: |
          echo "üîç Checking for Swift files not added to Xcode project..."

          # Find all Swift files (excluding Tests, Packages, and hidden directories)
          SWIFT_FILES=$(find . -name "*.swift" -not -path "*/Tests/*" -not -path "*/.*/*" -not -path "*/Package.swift" -not -path "*/Packages/*" | sed 's|^\./||')

          MISSING_FILES=""

          while IFS= read -r file; do
            FILENAME=$(basename "$file")

            # Check if file is in project.pbxproj
            if ! grep -q "$FILENAME" QuillStack.xcodeproj/project.pbxproj; then
              MISSING_FILES="${MISSING_FILES}${file}\n"
            fi
          done <<< "$SWIFT_FILES"

          if [ -n "$MISSING_FILES" ]; then
            echo ""
            echo "‚ùå ERROR: Swift files found that are not in Xcode project:"
            echo -e "$MISSING_FILES"
            echo ""
            echo "These files won't be compiled!"
            echo "Please add them to the QuillStack target in Xcode."
            exit 1
          fi

          echo "‚úÖ All Swift files are properly added to Xcode project"

      - name: Verify project builds
        run: |
          echo "üî® Verifying project builds..."
          set -o pipefail

          # Run build and capture output
          if xcodebuild -project QuillStack.xcodeproj -scheme QuillStack -sdk iphonesimulator -destination 'generic/platform=iOS Simulator' build 2>&1 | tee build.log; then
            echo "‚úÖ Build succeeded"
          else
            echo "‚ùå Build failed"
            echo ""
            echo "Errors:"
            grep -E "error:" build.log || echo "No specific errors found in log"
            exit 1
          fi
